import{getAuth as ge,onAuthStateChanged as oe,signOut as be,setPersistence as ve,browserLocalPersistence as we,signInWithEmailAndPassword as Ee,createUserWithEmailAndPassword as Se,updateProfile as Le,updatePassword as qe}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirestore as Me,collection as P,query as k,where as E,orderBy as K,limit as ue,getDocs as T,doc as L,onSnapshot as Ie,getDoc as Q,serverTimestamp as V,setDoc as R,deleteDoc as Pe,GeoPoint as xe,addDoc as Be}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{initializeApp as ke}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getStorage as Te,ref as _,uploadBytes as j,getDownloadURL as Y}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import{getFunctions as Ce,httpsCallable as re}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const $e={apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0},ee=ke($e),v=ge(ee),g=Me(ee),G=Te(ee),ie=Ce(ee);function d(e,t="info"){const n=document.querySelector(".toast-container");if(!n){console.error('Toast container element with class ".toast-container" was not found in your HTML!');return}const r={success:{icon:"fa-check-circle",header:"Success",bg:"text-bg-success"},error:{icon:"fa-exclamation-triangle",header:"Error",bg:"text-bg-danger"},info:{icon:"fa-info-circle",header:"Notice",bg:"text-bg-primary"}},o=r[t]||r.info,i=`toast-${Date.now()}`,s=`
        <div id="${i}" class="toast ${o.bg}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas ${o.icon} rounded me-2"></i>
                <strong class="me-auto">${o.header}</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${e}
            </div>
        </div>
    `;n.insertAdjacentHTML("beforeend",s);const a=document.getElementById(i);if(!a){console.error(`Failed to find toast element with ID: ${i}`);return}const c=new bootstrap.Toast(a,{autohide:!0,delay:5e3});a.addEventListener("hidden.bs.toast",()=>{a.remove()}),c.show()}async function He(){const e=document.getElementById("recent-memorials-container");if(e)try{const t=P(g,"memorials"),n=k(t,E("status","==","published"),K("createdAt","desc"),ue(5)),r=await T(n);if(r.empty){e.innerHTML='<p class="text-muted text-center w-100">No memorials have been added yet.</p>';return}let o="";r.forEach(i=>{const s={id:i.id,...i.data()},a=s.mainPhoto||"/logo1.png";o+=`
                <a href="/memorial?id=${s.id}" class="card text-decoration-none text-dark shadow-sm memorial-card" style="min-width: 200px;">
                    <img src="${a}" class="card-img-top" alt="${s.name}" style="height: 180px; object-fit: cover;">
                    <div class="card-body">
                        <h6 class="card-title mb-0">${s.name}</h6>
                    </div>
                </a>
            `}),e.innerHTML=o}catch(t){console.error("Error loading recent memorials:",t),e.innerHTML='<p class="text-danger text-center w-100">Could not load memorials at this time.</p>'}}async function De(){const e=document.getElementById("homepage-map-container");if(!(!e||typeof mapboxgl>"u"))try{mapboxgl.accessToken=void 0;const t=new mapboxgl.Map({container:e,style:"mapbox://styles/mapbox/satellite-streets-v12",center:[-98.5,39.8],zoom:3.5,interactive:!0});t.addControl(new mapboxgl.NavigationControl);const n=P(g,"memorials"),r=k(n,E("status","==","published"),E("location","!=",null)),o=await T(r),i=[];o.forEach(s=>{const a={id:s.id,...s.data()};a.location&&a.location.lng&&a.location.lat&&i.push({type:"Feature",geometry:{type:"Point",coordinates:[a.location.lng,a.location.lat]},properties:{title:a.name,url:`/memorial?id=${a.id}`}})}),t.on("load",()=>{t.addSource("memorials",{type:"geojson",data:{type:"FeatureCollection",features:i}}),t.addLayer({id:"memorial-points",type:"circle",source:"memorials",paint:{"circle-radius":6,"circle-color":"#0d6efd","circle-stroke-width":1,"circle-stroke-color":"#ffffff"}}),t.on("click","memorial-points",s=>{const a=s.features[0].geometry.coordinates.slice(),{title:c,url:f}=s.features[0].properties,m=`<strong>${c}</strong><br><a href="${f}">View Memorial</a>`;for(;Math.abs(s.lngLat.lng-a[0])>180;)a[0]+=s.lngLat.lng>a[0]?360:-360;new mapboxgl.Popup().setLngLat(a).setHTML(m).addTo(t)}),t.on("mouseenter","memorial-points",()=>{t.getCanvas().style.cursor="pointer"}),t.on("mouseleave","memorial-points",()=>{t.getCanvas().style.cursor=""})})}catch(t){console.error("Error initializing homepage map:",t),e.innerHTML='<p class="text-danger text-center p-5">Could not load the map.</p>'}}async function Ae(e){try{const t=await fetch("/pages/home.html");if(!t.ok)throw new Error(`Failed to fetch home.html: ${t.status} ${t.statusText}`);const n=await t.text();e.innerHTML=n,await He(),await De()}catch(t){console.error("A critical error occurred in loadHomePage:",t),e.innerHTML='<p class="text-center text-danger p-5">Could not load the homepage. Please check the console for errors.</p>'}}var Ne={};function Fe(e,t){if(!e||!t||typeof mapboxgl>"u"){console.error("Map container, location, or Mapbox GL JS is missing.");return}try{mapboxgl.accessToken=Ne.VITE_MAPBOX_ACCESS_TOKEN;const n=new mapboxgl.Map({container:e,style:"mapbox://styles/mapbox/streets-v12",center:[t.lng,t.lat],zoom:15,interactive:!0});n.addControl(new mapboxgl.NavigationControl),new mapboxgl.Marker().setLngLat([t.lng,t.lat]).addTo(n)}catch(n){console.error("Error initializing memorial map:",n),e.innerHTML='<p class="text-danger text-center">Could not load map.</p>'}}function ae(e){if(!e)return"";if(/^\d{4}$/.test(e.trim()))return e.trim();const t=new Date(`${e}T00:00:00`);if(isNaN(t.getTime()))return e;const n={year:"numeric",month:"long",day:"numeric",timeZone:"UTC"};return t.toLocaleDateString(void 0,n)}async function Ue(e,t){const n=await new Promise(m=>oe(v,p=>m(p))),r=t.tier||"memorial";e.querySelector("#display-name").textContent=t.name||"Unnamed Memorial",e.querySelector("#display-dates").textContent=`${ae(t.birthDate)} - ${ae(t.deathDate)}`,e.querySelector("#display-bio").innerHTML=t.bio?t.bio.replace(/\n/g,"<br>"):"No biography provided.";const o=e.querySelector("#display-main-media");t.mainPhoto?o.innerHTML=`<img src="${t.mainPhoto}" alt="${t.name}" class="img-fluid rounded shadow-sm">`:o.innerHTML='<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 300px;"><i class="fas fa-image fa-3x text-muted"></i></div>';const i=e.querySelector("#edit-memorial-button");i&&(n&&n.uid===t.curatorId?i.style.display="block":i.style.display="none");const s=e.querySelector("#milestones-section-display"),a=e.querySelector("#quotes-section-display"),c=e.querySelector("#photos-section-display"),f=e.querySelector("#historian-content-display");if(s.style.display="none",a.style.display="none",c.style.display="none",f.style.display="none",(r==="storyteller"||r==="legacy"||r==="historian")&&(t.milestones&&t.milestones.length>0&&(s.querySelector("#display-milestones").innerHTML=t.milestones.map(m=>`<li class="list-group-item"><strong>${m.year}:</strong> ${m.description}</li>`).join(""),s.style.display="block"),t.quotes&&t.quotes.length>0&&(a.querySelector("#display-quotes").innerHTML=t.quotes.map(m=>`<li class="mb-2"><blockquote>"${m.quote}"</blockquote></li>`).join(""),a.style.display="block"),t.photos&&t.photos.length>0&&(c.querySelector("#display-photos").innerHTML=t.photos.map(m=>`<div class="col-6 col-md-4 col-lg-3"><a href="${m}" target="_blank"><img src="${m}" class="img-fluid rounded shadow-sm"></a></div>`).join(""),c.style.display="block")),r==="historian"){f.style.display="block",t.cemeteryAddress&&(e.querySelector("#display-cemetery-address").textContent=t.cemeteryAddress),t.location&&setTimeout(()=>Fe(e.querySelector("#map-container"),t.location),100);const m=e.querySelector("#relatives-section-display");if(t.relatives&&t.relatives.length>0){const p=e.querySelector("#display-relatives"),y=e.querySelector("#relative-item-template");p.innerHTML="",t.relatives.forEach(l=>{const u=y.content.cloneNode(!0);u.querySelector(".relative-info").textContent=`${l.name} (${l.relationship})`;const b=u.querySelector(".view-memorial-btn"),x=u.querySelector(".find-pin-btn");l.memorialId?(b.href=`/memorial?id=${l.memorialId}`,b.style.display="inline-block"):(x.href=`/scout-mode?name=${encodeURIComponent(l.name)}`,x.style.display="inline-block"),p.appendChild(u)}),m.style.display="block"}}}function Oe(e,t){var n;(n=e.querySelector("#edit-memorial-button"))==null||n.addEventListener("click",()=>{history.pushState(null,"",`/memorial-form?id=${t}`),window.dispatchEvent(new PopStateEvent("popstate"))})}async function ze(e,t,n){try{const r=await fetch("/pages/memorial-template.html");if(!r.ok)throw new Error("HTML content not found");if(e.innerHTML=await r.text(),document.body.className="memorial-page-body",t){const o=L(g,"memorials",t),i=Ie(o,async s=>{try{if(s.exists()){const a=s.data();await Ue(e,a),Oe(e,t),e.querySelector("#memorial-layout-container").style.display="block"}else e.querySelector("#memorial-layout-container").style.display="none",e.querySelector("#no-memorial-message").style.display="block"}catch(a){console.error("Error rendering memorial data:",a),e.innerHTML='<div class="container p-5"><p class="text-center text-danger">Could not display the memorial due to an error. Please check the console.</p></div>'}},s=>{console.error("Error listening to memorial document:",s)});n(i)}else e.querySelector("#memorial-layout-container").style.display="none",e.querySelector("#no-memorial-message").style.display="block"}catch(r){console.error("Failed to load memorial page structure:",r)}}function te(e,t,n,r){const o=document.getElementById(e),i=document.getElementById(t);if(!o||!i){console.error(`Missing container #${e} or template #${t}`);return}if(o.innerHTML="",n.length===0){o.innerHTML='<p class="text-muted">No items to display.</p>';return}n.forEach(s=>{const a=i.content.cloneNode(!0);r(a,s.data(),s.id),o.appendChild(a)})}async function _e(e){const t=k(P(g,"memorials"),E("curatorId","==",e.uid),E("status","==","draft"),K("createdAt","desc")),n=await T(t);te("draft-list-container","memorial-item-template",n.docs,(r,o,i)=>{r.querySelector(".memorial-name").textContent=o.name||"Untitled Draft",r.querySelector(".view-link").href=`/memorial?id=${i}`,r.querySelector(".edit-link").href=`/memorial-form?id=${i}`})}async function je(e){const t=k(P(g,"memorials"),E("curatorId","==",e.uid),E("status","==","approved"),K("createdAt","desc")),n=await T(t);te("memorial-list-container","memorial-item-template",n.docs,(r,o,i)=>{r.querySelector(".memorial-name").textContent=o.name,r.querySelector(".view-link").href=`/memorial?id=${i}`,r.querySelector(".edit-link").href=`/memorial-form?id=${i}`})}async function Ye(){const e=k(P(g,"memorials"),E("status","==","pending"),K("createdAt","desc")),t=await T(e);te("pending-list-container","pending-item-template",t.docs,(n,r,o)=>{const i=n.querySelector(".submission-name");i&&(i.textContent=r.name||"Unnamed Submission");const s=n.querySelector(".submission-byline");s&&(s.textContent=`Submitted by: ${r.submitterName||"Unknown"}`);const a=n.querySelector(".submission-thumbnail");a&&r.mainPhoto&&(a.src=r.mainPhoto)})}async function Ge(){const e=k(P(g,"tributes"),E("status","==","pending"),K("createdAt","desc")),t=await T(e);te("pending-tributes-container","pending-tribute-template",t.docs,(n,r,o)=>{n.querySelector(".tribute-message").textContent=r.message,n.querySelector(".tribute-author").textContent=r.authorName,n.querySelector(".tribute-memorial-name").textContent=r.memorialName})}async function le(e,t){try{const n=await fetch("/pages/curator-panel.html");if(!n.ok)throw new Error("Failed to load curator panel HTML");if(e.innerHTML=await n.text(),t){const r=document.getElementById("auth-section"),o=document.getElementById("dashboard");r&&(r.style.display="none"),o&&(o.style.display="block");const i=document.getElementById("curator-name");i&&t.displayName&&(i.textContent=t.displayName),_e(t),je(t),Ye(),Ge()}}catch(n){console.error("Error loading curator panel:",n),e.innerHTML='<p class="text-center text-danger p-5">Could not load the curator panel.</p>'}}const Ke=re(ie,"geocodeAddress"),Ve=re(ie,"generateBioFromPrompts");let w={mainPhoto:null,photos:[],videos:[]},S={mainPhoto:null,photos:[],videos:[]},me={photos:[]},F,C=null;async function We(e){const t=e.querySelector("#generate-bio-btn"),n=e.querySelector("#memorial-name").value,r=e.querySelector("#memorial-bio");if(!n){d("Please enter the person's name first.","info");return}const o=e.querySelector("#prompt-hobbies").value.trim(),i=e.querySelector("#prompt-memory").value.trim(),s=e.querySelector("#prompt-personality").value.trim(),a=[o?`Hobbies and passions: ${o}`:"",i?`A favorite memory: ${i}`:"",s?`Personality traits: ${s}`:""].filter(Boolean).join(`
- `);if(!a){d("Please answer at least one question to generate the biography.","info");return}t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm"></span> Generating...';try{const c=await Ve({name:n,promptData:a});c.data.biography&&(r.value=c.data.biography,d("Biography generated! You can edit it below.","success"))}catch(c){console.error("Error generating biography:",c),d("Could not generate biography. Please try again.","error")}finally{t.disabled=!1,t.innerHTML='<i class="fas fa-magic"></i> Write Biography with AI ✨'}}function Xe(e){if(!e||e.trim()==="")return`memorial-${Math.random().toString(36).substring(2,10)}`;const t=e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),n=Math.random().toString(36).substring(2,8);return`${t}-${n}`}function Je(){w={mainPhoto:null,photos:[],videos:[]},S={mainPhoto:null,photos:[],videos:[]},me={photos:[],videos:[]},F=null,C=null}function ye(){return new Promise(e=>{const t=oe(v,n=>{t(),e(n)})})}function O(e,t,n,r=!1){const o=e.querySelector(`#${t}`);if(!o)return;const i=typeof n=="string"?n:URL.createObjectURL(n),s=document.createElement("div");s.className="col-4 media-preview-item",s.innerHTML=`<img src="${i}" class="img-fluid rounded"><button type="button" class="btn btn-danger btn-sm remove-media-btn">×</button>`,o.appendChild(s),s.querySelector(".remove-media-btn").addEventListener("click",()=>{if(r)if(t==="main-photo-preview")S.mainPhoto=null;else{const a=S.photos.indexOf(n);a>-1&&me.photos.push(S.photos.splice(a,1)[0])}else if(t==="main-photo-preview")w.mainPhoto=null;else{const a=w.photos.indexOf(n);a>-1&&w.photos.splice(a,1)}s.remove()})}function A(e,t,n={}){const r=e.querySelector(`#${t}-container`);if(r)if(t==="relatives"){const o=e.querySelector("#relative-input-template");if(!o)return;const i=o.content.cloneNode(!0);i.querySelector(".relative-name-input").value=n.name||"",i.querySelector(".relative-relationship-input").value=n.relationship||"",i.querySelector(".relative-memorial-id").value=n.memorialId||"";const s=i.querySelector(".link-btn");n.memorialId&&(s.textContent="Linked ✔",s.classList.add("btn-success"),s.classList.remove("btn-outline-primary")),s.addEventListener("click",a=>{C=a.target.closest(".dynamic-input-group"),F&&F.show()}),i.querySelector(".remove-btn").addEventListener("click",a=>{a.target.closest(".dynamic-input-group").remove()}),r.appendChild(i)}else{const o=document.createElement("div");o.className="row g-2 mb-2 dynamic-input-group align-items-center";let i="";t==="milestones"?(o.setAttribute("draggable","true"),i=`<div class="col-1 text-center"><i class="fas fa-grip-vertical drag-handle"></i></div><div class="col-md-3"><input type="text" class="form-control milestone-year-input" placeholder="Year" value="${n.year||""}"></div><div class="col-md-6"><input type="text" class="form-control milestone-desc-input" placeholder="Description" value="${n.description||""}"></div><div class="col-md-2"><button type="button" class="btn btn-outline-danger btn-sm w-100 remove-btn"><i class="fas fa-trash"></i></button></div>`):t==="quotes"&&(i=`<div class="col-md-10"><input type="text" class="form-control quote-input" placeholder="Quote" value="${n.quote||""}"></div><div class="col-md-2"><button type="button" class="btn btn-outline-danger btn-sm w-100 remove-btn"><i class="fas fa-trash"></i></button></div>`),o.innerHTML=i,r.appendChild(o),o.querySelector(".remove-btn").addEventListener("click",()=>o.remove())}}async function Qe(e){const t=document.getElementById("relative-search-results");t.innerHTML='<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';const n=e.toLowerCase();if(n.length<2){t.innerHTML='<p class="text-muted text-center">Please type at least 2 characters.</p>';return}try{const r=P(g,"memorials"),o=k(r,E("status","==","approved"),E("name_lowercase",">=",n),E("name_lowercase","<=",n+""),ue(10)),i=await T(o);if(i.empty){t.innerHTML='<p class="text-muted text-center">No memorials found.</p>';return}t.innerHTML="",i.forEach(s=>{const a={id:s.id,...s.data()},c=document.createElement("a");c.href="#",c.className="list-group-item list-group-item-action relative-search-result-item",c.innerHTML=`<strong>${a.name}</strong><br><small>${a.birthDate||""} - ${a.deathDate||""}</small>`,c.addEventListener("click",f=>{if(f.preventDefault(),C){C.querySelector(".relative-name-input").value=a.name,C.querySelector(".relative-memorial-id").value=a.id;const m=C.querySelector(".link-btn");m.textContent="Linked ✔",m.classList.add("btn-success"),m.classList.remove("btn-outline-primary")}F&&F.hide()}),t.appendChild(c)})}catch(r){console.error("Error searching memorials:",r),t.innerHTML='<p class="text-center text-danger">Search failed. Please check the console for errors.</p>'}}async function Ze(e,t,n){e.preventDefault();const r=e.target;if(!r.checkValidity()){r.classList.add("was-validated");return}const o=await ye();if(!o){d("You must be signed in to save a memorial.","error");return}const i=n.querySelector("#save-memorial-button");i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm"></span> Saving...';try{const s=n.querySelector("#memorial-name").value,a=t||Xe(s),c=L(g,"memorials",a),f=n.querySelector("#memorial-birth-date").value,m=n.querySelector("#memorial-death-date").value,p=l=>{if(!l||!l.includes("-")||l.length<8)return null;try{const u=new Date(l);return isNaN(u.getTime())?null:`${(u.getUTCMonth()+1).toString().padStart(2,"0")}-${u.getUTCDate().toString().padStart(2,"0")}`}catch{return null}},y={name:s,name_lowercase:s.toLowerCase(),title:n.querySelector("#memorial-title").value,birthDate:f,deathDate:m,birthMonthDay:p(f),deathMonthDay:p(m),bio:n.querySelector("#memorial-bio").value,tier:n.querySelector("#memorial-tier").value,curatorId:o.uid,status:"pending",cemeteryName:n.querySelector("#memorial-cemetery-name").value,cemeteryAddress:n.querySelector("#memorial-cemetery-address").value,relatives:Array.from(n.querySelectorAll("#relatives-container .dynamic-input-group")).map(l=>({name:l.querySelector(".relative-name-input").value,relationship:l.querySelector(".relative-relationship-input").value,memorialId:l.querySelector(".relative-memorial-id").value||null})),milestones:Array.from(n.querySelectorAll("#milestones-container .dynamic-input-group")).map(l=>({year:l.querySelector(".milestone-year-input").value,description:l.querySelector(".milestone-desc-input").value})),quotes:Array.from(n.querySelectorAll("#quotes-container .dynamic-input-group")).map(l=>({quote:l.querySelector(".quote-input").value})),photos:[...S.photos]};if(t||(y.tierSortOrder=4,y.createdAt=V()),w.mainPhoto){const l=_(G,`memorials/${a}/main-photo.jpg`);await j(l,w.mainPhoto),y.mainPhoto=await Y(l)}else S.mainPhoto?y.mainPhoto=S.mainPhoto:y.mainPhoto=null;if(w.photos.length>0){const l=w.photos.map((b,x)=>{const h=_(G,`memorials/${a}/photo-${Date.now()}-${x}`);return j(h,b).then(U=>Y(U.ref))}),u=await Promise.all(l);y.photos.push(...u)}if(y.tier==="historian"&&y.cemeteryAddress)try{const l=await Ke({address:y.cemeteryAddress});y.location=l.data}catch(l){console.error("Geocoding failed:",l)}await R(c,y,{merge:!0}),d("Memorial saved successfully!","success"),history.pushState(null,"",`/memorial?id=${a}`),window.dispatchEvent(new PopStateEvent("popstate"))}catch(s){console.error("Error saving memorial:",s),d("There was an error saving the memorial.","error")}finally{i.disabled=!1,i.textContent="Save Memorial"}}async function Re(e){if(confirm(`Are you sure you want to permanently delete this memorial?

All associated photos, tributes, and data will be lost forever. This action cannot be undone.`))try{await Pe(L(g,"memorials",e)),d("Memorial permanently deleted.","success"),history.pushState(null,"","/curator-panel"),window.dispatchEvent(new PopStateEvent("popstate"))}catch(n){console.error("Error deleting memorial:",n),d("Failed to delete memorial.","error")}}async function et(e,t){const n=L(g,"memorials",t),r=await Q(n);if(r.exists()){const o=r.data();e.querySelector("#form-title").textContent="Edit Your Memorial",e.querySelector("#memorial-name").value=o.name||"",e.querySelector("#memorial-title").value=o.title||"",e.querySelector("#memorial-tier").value=o.tier||"memorial",e.querySelector("#memorial-birth-date").value=o.birthDate||"",e.querySelector("#memorial-death-date").value=o.deathDate||"",e.querySelector("#memorial-bio").value=o.bio||"",e.querySelector("#memorial-cemetery-name").value=o.cemeteryName||"",e.querySelector("#memorial-cemetery-address").value=o.cemeteryAddress||"",o.mainPhoto&&(S.mainPhoto=o.mainPhoto,O(e,"main-photo-preview",o.mainPhoto,!0)),o.photos&&o.photos.length>0&&(S.photos=[...o.photos],S.photos.forEach(s=>O(e,"photos-preview",s,!0))),o.relatives&&o.relatives.length>0&&o.relatives.forEach(s=>A(e,"relatives",s)),o.milestones&&o.milestones.length>0&&o.milestones.forEach(s=>A(e,"milestones",s)),o.quotes&&o.quotes.length>0&&o.quotes.forEach(s=>A(e,"quotes",s)),ne(e,o.tier);const i=e.querySelector("#delete-memorial-button");i&&(i.style.display="block")}}function ne(e,t){const n=e.querySelector("#memorial-photos"),r=n?n.parentElement:null,o=e.querySelector("#videos-section"),i=e.querySelector("#milestones-section"),s=e.querySelector("#quotes-section"),a=e.querySelector("#historian-fields");r&&(r.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="none"),s&&(s.style.display="none"),a&&(a.style.display="none"),(t==="storyteller"||t==="legacy"||t==="historian")&&(r&&(r.style.display="block"),i&&(i.style.display="block"),s&&(s.style.display="block")),(t==="legacy"||t==="historian")&&o&&(o.style.display="block"),t==="historian"&&a&&(a.style.display="block")}async function tt(e,t){var c,f,m,p,y,l;Je(),await ye()||d("Sign in as a curator to save your work.","info");const r=t.get("id"),o=t.get("tier");if(r)await et(e,r);else if(o){const u=e.querySelector("#memorial-tier");u&&(u.value=o),ne(e,o)}else{const u=e.querySelector("#memorial-tier");u&&(u.value="memorial"),ne(e,"memorial")}const i=document.getElementById("linkRelativeModal");if(typeof bootstrap<"u"&&i){F=new bootstrap.Modal(i);const u=document.getElementById("relativeSearchInput");u.addEventListener("input",b=>Qe(b.target.value)),i.addEventListener("hidden.bs.modal",()=>{u.value="",document.getElementById("relative-search-results").innerHTML=""})}const s=u=>{history.pushState(null,"",u),window.dispatchEvent(new PopStateEvent("popstate"))};(c=e.querySelector("#generate-bio-btn"))==null||c.addEventListener("click",()=>We(e)),e.querySelector("#memorialForm").addEventListener("submit",u=>Ze(u,r,e)),e.querySelector("#go-back-button").addEventListener("click",()=>s("/curator-panel")),e.querySelector("#cancel-memorial-button").addEventListener("click",()=>s("/curator-panel"));const a=e.querySelector("#delete-memorial-button");a&&a.addEventListener("click",()=>{r&&Re(r)}),(f=e.querySelector("#add-relative-button"))==null||f.addEventListener("click",()=>A(e,"relatives")),(m=e.querySelector("#add-milestone-button"))==null||m.addEventListener("click",()=>A(e,"milestones",{})),(p=e.querySelector("#add-quote-button"))==null||p.addEventListener("click",()=>A(e,"quotes",{})),(y=e.querySelector("#memorial-main-photo"))==null||y.addEventListener("change",u=>{u.target.files[0]&&(w.mainPhoto=u.target.files[0],e.querySelector("#main-photo-preview").innerHTML="",O(e,"main-photo-preview",w.mainPhoto))}),(l=e.querySelector("#memorial-photos"))==null||l.addEventListener("change",u=>{w.photos=Array.from(u.target.files),e.querySelector("#photos-preview").innerHTML="",S.photos.forEach(b=>O(e,"photos-preview",b,!0)),w.photos.forEach(b=>O(e,"photos-preview",b))})}async function nt(e,t){try{const n=await fetch("/pages/memorial-form.html");if(!n.ok)throw new Error("HTML content not found");e.innerHTML=await n.text(),await tt(e,t)}catch(n){console.error("Failed to load memorial form page:",n)}}const J=new Map;function ot(e){const t=document.getElementById(e);if(!t){console.error(`Modal element with ID #${e} not found.`);return}let n=bootstrap.Modal.getOrCreateInstance(t);J.set(e,n),t.addEventListener("hidden.bs.modal",()=>{const r=J.get(e);r&&(r.dispose(),J.delete(e))},{once:!0}),n.show()}function rt(e){const t=J.get(e);if(t)t.hide();else{const n=document.getElementById(e);if(n){const r=bootstrap.Modal.getInstance(n);r&&r.hide()}}}var fe={};let $,N,I=[],B=[],z=null,H=null;const it=re(ie,"transcribeHeadstoneImage");function st(){document.body.classList.add("scout-mode-active"),console.log("Entered Scout Mode.")}function ce(){document.body.classList.remove("scout-mode-active"),console.log("Exited Scout Mode: UI restored.")}async function at(e){const t=v.currentUser;if(!t)return d("You must be signed in to save a pin.","error"),null;try{const n={curatorId:t.uid,createdAt:V(),location:new xe(e.lat,e.lng),status:"draft",name:"Untitled Memorial",tier:"memorial",tierSortOrder:4},r=await Be(P(g,"memorials"),n);return d("New draft saved! You can add details later from your Curator Panel.","success"),r.id}catch(n){return console.error("Error saving pin as draft:",n),d("Could not save the pin.","error"),null}}function pe(e){if(!e||e.trim()==="")return`memorial-${Math.random().toString(36).substring(2,10)}`;const t=e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,""),n=Math.random().toString(36).substring(2,8);return`${t}-${n}`}function D(e){const t=document.getElementById("scout-wizard");t&&(t.className=`step-${e}`)}function lt(){try{mapboxgl.accessToken=fe.VITE_MAPBOX_ACCESS_TOKEN,$=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/satellite-streets-v12",center:[-98.5,39.8],zoom:3.5}),$.addControl(new mapboxgl.NavigationControl)}catch(e){console.error("Single-Pin Map initialization failed:",e)}}function ct(){try{mapboxgl.accessToken=fe.VITE_MAPBOX_ACCESS_TOKEN,N=new mapboxgl.Map({container:"multi-pin-map",style:"mapbox://styles/mapbox/satellite-streets-v12",center:[-98.5,39.8],zoom:3.5}),N.addControl(new mapboxgl.NavigationControl)}catch(e){console.error("Multi-Pin Map initialization failed:",e)}}function dt(){const e=document.getElementById("captured-pins-list"),t=document.getElementById("finish-batch-btn");!e||!t||(I.length===0?(e.innerHTML='<small class="text-muted">No pins captured yet.</small>',t.disabled=!0):(e.innerHTML="",I.forEach((n,r)=>{const o=document.createElement("img");o.className="captured-pin-thumb",o.src=URL.createObjectURL(n.photoFile),o.title=`Pin ${r+1}`,e.appendChild(o)}),t.disabled=!1))}async function ut(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.capture="environment",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",()=>{if(e.files&&e.files[0]){const t=e.files[0],n=N.getCenter();I.push({location:n,photoFile:t}),dt()}e.remove()}),e.click()}async function mt(){const e=document.getElementById("finish-batch-btn");e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm"></span> Saving...';const t=v.currentUser;if(!t||t.isAnonymous){d("Please sign in as a curator to save a batch of pins.","error"),e.disabled=!1,e.textContent="Finish & Save Batch";return}d(`Uploading ${I.length} drafts...`,"info");const n=I.map(async r=>{const o=`memorials/pending/${Date.now()}-${r.photoFile.name}`,i=_(G,o),s=await j(i,r.photoFile),a=await Y(s.ref),c={location:{lat:r.location.lat,lng:r.location.lng},photos:[a],mainPhoto:a,createdAt:V(),status:"draft",curatorId:t.uid,tier:"memorial",tierSortOrder:4,name:"Untitled Draft"},f=pe(`draft-${Date.now()}`),m=L(g,"memorials",f);return R(m,c)});try{await Promise.all(n),d(`${I.length} drafts saved! Add details from your Curator Panel.`,"success"),I=[],history.pushState(null,"","/curator-panel"),window.dispatchEvent(new PopStateEvent("popstate"))}catch(r){console.error("Error saving batch:",r),d("An error occurred while saving the batch.","error")}finally{e.disabled=!1,e.textContent="Finish & Save Batch"}}function yt(e){const t=v.currentUser,n=t&&!t.isAnonymous,r=document.getElementById("scout-photo-preview");if(!r)return;B=Array.from(e),z=null;const o=document.getElementById("transcribe-button"),i=document.getElementById("use-photo-button"),s=document.getElementById("transcribe-helper");if(o&&(o.disabled=!0),i&&(i.style.display="none"),s&&(s.style.display="none"),B.length>0){z=B[0],i&&(i.style.display="block"),n?o&&(o.disabled=!1):s&&(s.style.display="block");const a=new FileReader;a.onload=c=>{r.innerHTML=`<img src="${c.target.result}" alt="Headstone preview" style="width: 100%; height: 100%; object-fit: contain;">`},a.readAsDataURL(B[0])}}async function ft(){const e=document.getElementById("transcribe-button");if(!z||!e||e.disabled)return;const t=v.currentUser;if(!t||t.isAnonymous){d("You must be signed in to use this feature.","error");return}e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm"></span> Transcribing...';try{const n=`transcriptions/${t.uid}/${Date.now()}-${z.name}`,r=_(G,n),o=await j(r,z),i=await Y(o.ref),a=(await it({imageUrl:i})).data.text;document.getElementById("ocr-full-text").value=a,document.getElementById("ocr-results-wrapper").style.display="block";const c=a.split(`
`),f=document.getElementById("scout-name");f&&(f.value=c[0]||"");const m=/(\d{4})\s*[-–—]\s*(\d{4})/,p=a.match(m);if(p){const y=document.getElementById("scout-birth-date"),l=document.getElementById("scout-death-date");y&&(y.value=p[1]),l&&(l.value=p[2])}d("Transcription complete! Please review for accuracy.","success"),D(3)}catch(n){console.error("OCR Error:",n),d(`Could not transcribe text: ${n.message}`,"error")}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-magic"></i> Transcribe')}}async function he(e=null,t=null){var n,r,o,i;try{if(!H)throw new Error("Location pin was not set before submitting.");const s=[];if(B.length>0){const p=B.map(l=>{const u=_(G,`memorials/submissions/${Date.now()}-${l.name}`);return j(u,l).then(b=>Y(b.ref))}),y=await Promise.all(p);s.push(...y)}const a=((n=document.getElementById("scout-name"))==null?void 0:n.value)||"Untitled Draft",c={name:a,name_lowercase:a.toLowerCase(),birthDate:((r=document.getElementById("scout-birth-date"))==null?void 0:r.value)||"",deathDate:((o=document.getElementById("scout-death-date"))==null?void 0:o.value)||"",location:{lat:H.lat,lng:H.lng},photos:s,mainPhoto:s.length>0?s[0]:null,createdAt:V(),tier:"memorial",tierSortOrder:4};e?(c.status="draft",c.curatorId=e):(c.status="pending",c.submitterName=t.name,c.submitterEmail=t.email);const f=pe(a),m=L(g,"memorials",f);await R(m,c),d("Submission successful!","success"),(i=document.getElementById("pin-form"))==null||i.reset(),document.getElementById("scout-photo-preview").innerHTML='<div class="placeholder-box"><i class="fas fa-camera fa-3x text-muted"></i></div>',B=[],H=null,D(1)}catch(s){console.error("Error saving pin:",s),d("There was an error saving the draft.","error")}}async function pt(e){e.preventDefault();const t=document.getElementById("wizard-submit-button");if(!t)return;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm"></span> Saving...';const n=v.currentUser;if(!n||n.isAnonymous){ot("contributorModal"),t.disabled=!1,t.textContent="Submit";return}await he(n.uid),t.disabled=!1,t.textContent="Submit"}async function ht(){var r,o,i;const e=document.getElementById("submitContributionButton");if(!e)return;e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm"></span> Submitting...';const t=(r=document.getElementById("contributorName"))==null?void 0:r.value,n=(o=document.getElementById("contributorEmail"))==null?void 0:o.value;if(!t||!n){d("Please provide your name and email.","info"),e.disabled=!1,e.textContent="Submit for Review";return}await he(null,{name:t,email:n}),rt("contributorModal"),(i=document.getElementById("contributorForm"))==null||i.reset(),e.disabled=!1,e.textContent="Submit for Review"}function gt(){var o,i,s,a,c,f,m,p,y,l,u,b,x;(o=document.getElementById("set-pin-button"))==null||o.addEventListener("click",()=>{H=$.getCenter(),D(2)}),(i=document.getElementById("skip-photo-button"))==null||i.addEventListener("click",async h=>{h.preventDefault();const U=$.getCenter();if(!U){d("Please set a pin on the map first.","info");return}await at({lat:U.lat,lng:U.lng})&&(history.pushState(null,"","/curator-panel"),window.dispatchEvent(new PopStateEvent("popstate")))}),(s=document.getElementById("gps-button"))==null||s.addEventListener("click",()=>{navigator.geolocation.getCurrentPosition(h=>{$&&$.flyTo({center:[h.coords.longitude,h.latitude],zoom:18})},h=>{d(`Error getting location: ${h.message}`,"error")})}),(a=document.getElementById("back-to-location"))==null||a.addEventListener("click",h=>{h.preventDefault(),D(1)}),(c=document.getElementById("use-photo-button"))==null||c.addEventListener("click",()=>D(3)),(f=document.getElementById("scout-photos"))==null||f.addEventListener("change",h=>yt(h.target.files)),(m=document.getElementById("transcribe-button"))==null||m.addEventListener("click",ft),(p=document.getElementById("back-to-photo"))==null||p.addEventListener("click",h=>{h.preventDefault(),D(2)}),(y=document.getElementById("pin-form"))==null||y.addEventListener("submit",pt),(l=document.getElementById("submitContributionButton"))==null||l.addEventListener("click",ht);const e=document.getElementById("scout-wizard"),t=document.getElementById("multi-pin-mode"),n=document.getElementById("wizard-mode-btn"),r=document.getElementById("multi-pin-mode-btn");n==null||n.addEventListener("click",()=>{e&&(e.style.display="block"),t&&(t.style.display="none"),n.classList.add("active","btn-primary"),n.classList.remove("btn-outline-primary"),r.classList.remove("active","btn-primary"),r.classList.add("btn-outline-primary")}),r==null||r.addEventListener("click",()=>{t&&(t.style.display="flex"),e&&(e.style.display="none"),r.classList.add("active","btn-primary"),r.classList.remove("btn-outline-primary"),n.classList.remove("active","btn-primary"),n.classList.add("btn-outline-primary"),N||ct()}),(u=document.getElementById("add-pin-btn"))==null||u.addEventListener("click",ut),(b=document.getElementById("finish-batch-btn"))==null||b.addEventListener("click",mt),(x=document.getElementById("multi-pin-gps-btn"))==null||x.addEventListener("click",()=>{navigator.geolocation.getCurrentPosition(h=>{N&&N.flyTo({center:[h.coords.longitude,h.latitude],zoom:18})},h=>{d(`Error getting location: ${h.message}`,"error")})})}async function bt(e,t){try{const n=await fetch("/pages/scout-mode.html");if(!n.ok)throw new Error("HTML content for Scout Mode not found");if(e.innerHTML=await n.text(),st(),t&&t(ce),H=null,I=[],typeof mapboxgl<"u")lt(),gt();else throw new Error("Mapbox library has not loaded yet.")}catch(n){console.error("Failed to load Scout Mode page:",n),e.innerHTML='<div class="alert alert-danger m-3" role="alert"><h4 class="alert-heading">Error</h4><p>Could not load Scout Mode. Please ensure you have a stable internet connection and try again.</p><hr><a href="/" class="btn btn-secondary">Go back to Homepage</a></div>',ce()}}let se;function vt(e){e.preventDefault(),se=e,window.dispatchEvent(new CustomEvent("pwa-prompt-available"))}function wt(){return se}function Et(){se=null}const St="August 17, 2025, 1127";console.log(`%c✅ Headstone Legacy Deployed 
%cBuild Time: ${St}`,"color: #28a745; font-size: 1.2em; font-weight: bold;","color: #6c757d; font-size: 1em;");let q=null,Z=!1,W=null,X=null;async function Lt(e,t){try{return await ve(v,we),await Ee(v,e,t),d("Login successful!","success"),!0}catch(n){return console.error("Sign-in error:",n.code,n.message),d("Failed to sign in. Please check your email and password.","error"),!1}}async function qt(e,t,n){try{const o=(await Se(v,t,n)).user;return await Le(o,{displayName:e}),await R(L(g,"users",o.uid),{name:e,email:t,createdAt:V(),isScout:!1,isAdmin:!1}),d("Account created successfully! Please sign in.","success"),!0}catch(r){return console.error("Sign-up error:",r.code,r.message),d(`Could not create account: ${r.message}`,"error"),!1}}async function Mt(e){if(!v.currentUser){d("You must be signed in to change your password.","error");return}if(e.length<6){d("Password must be at least 6 characters long.","error");return}try{await qe(v.currentUser,e),d("Password updated successfully.","success");const t=document.getElementById("changePasswordModal");if(t){const n=bootstrap.Modal.getInstance(t);n&&n.hide()}}catch(t){console.error("Password change error:",t),d(`Error changing password: ${t.message}`,"error")}}async function It(e){const t=document.getElementById("signInLink"),n=document.getElementById("userDropdown"),r=document.getElementById("scout-nav-item");if(e&&!e.isAnonymous){t&&(t.style.display="none"),n&&n.classList.remove("d-none");try{const o=L(g,"users",e.uid),i=await Q(o);i.exists()&&(i.data().isScout||i.data().isAdmin)?r&&(r.style.display="list-item"):r&&(r.style.display="none")}catch(o){console.error("Error fetching user role for nav:",o),r&&(r.style.display="none")}}else t&&(t.style.display="block"),n&&n.classList.add("d-none"),r&&(r.style.display="none")}async function de(e,t){try{const n=await fetch(`/pages/${t}.html`);if(!n.ok)throw new Error(`Page not found: /pages/${t}.html`);e.innerHTML=await n.text()}catch(n){console.error("Error loading static page:",n),e.innerHTML='<p class="text-center text-danger p-5">Could not load page.</p>'}}async function M(){X&&(X(),X=null),W&&(W(),W=null);const e=window.location.pathname,t=new URLSearchParams(window.location.search),n=document.getElementById("app-root");if(!n){console.error("Fatal Error: #app-root element not found.");return}switch(n.innerHTML='<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>',e){case"/":Ae(n);break;case"/memorial":ze(n,t.get("id"),r=>{W=r});break;case"/curator-panel":if(q&&!q.isAnonymous){const r=L(g,"users",q.uid),o=await Q(r);o.exists()&&(o.data().isScout||o.data().isAdmin)?le(n,q):(d("You are not authorized to view the curator panel.","error"),history.pushState(null,"","/"),M())}else le(n,null);break;case"/memorial-form":nt(n,t);break;case"/scout-mode":if(q&&!q.isAnonymous){const r=L(g,"users",q.uid),o=await Q(r);o.exists()&&(o.data().isScout||o.data().isAdmin)?bt(n,i=>{X=i}):(d("You are not authorized for this page.","error"),history.pushState(null,"","/"),M())}else d("Please sign in to access Scout Mode.","info"),history.pushState(null,"","/curator-panel"),M();break;case"/get-started":de(n,"get-started");break;case"/scout":de(n,"scout");break;default:n.innerHTML='<div class="text-center p-5"><h2>404 - Page Not Found</h2></div>';break}}function Pt(){document.body.addEventListener("submit",async n=>{if(n.target.id==="signInForm"){n.preventDefault();const r=document.getElementById("signInEmail").value,o=document.getElementById("signInPassword").value;await Lt(r,o)&&(history.pushState(null,"","/"),M())}if(n.target.id==="signUpForm"){n.preventDefault();const r=document.getElementById("signUpName").value,o=document.getElementById("signUpEmail").value,i=document.getElementById("signUpPassword").value;await qt(r,o,i)&&(history.pushState(null,"","/curator-panel"),M())}}),document.body.addEventListener("click",n=>{var i;const r=n.target;r.id==="signOutLink"&&(n.preventDefault(),be(v).then(()=>{d("You have been signed out.","info"),window.location.href="/"})),r.id==="savePasswordButton"&&Mt(document.getElementById("newPassword").value),r.id==="show-signup"&&(n.preventDefault(),document.getElementById("login-form").style.display="none",document.getElementById("signup-form").style.display="block"),r.id==="show-signin"&&(n.preventDefault(),document.getElementById("login-form").style.display="block",document.getElementById("signup-form").style.display="none");const o=r.closest("a");Z&&o&&((i=o.getAttribute("href"))!=null&&i.startsWith("/"))&&!o.hasAttribute("target")&&o.id!=="show-signup"&&o.id!=="show-signin"&&o.id!=="signOutLink"&&(n.preventDefault(),history.pushState(null,"",o.href),M())});const e=document.getElementById("installPwaItem"),t=document.getElementById("installPwaButton");window.addEventListener("beforeinstallprompt",n=>{vt(n),e&&e.classList.remove("d-none")}),t&&t.addEventListener("click",async()=>{const n=wt();n&&(n.prompt(),await n.userChoice,Et(),e&&e.classList.add("d-none"))}),window.addEventListener("popstate",()=>{Z&&M()})}document.addEventListener("DOMContentLoaded",()=>{Pt(),oe(v,e=>{const t=!!q,n=!!e;q=e,It(e),Z?t!==n&&M():(Z=!0,M())})});
